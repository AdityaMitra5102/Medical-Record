{% extends "layout.html" %}
{% block body %}
<!-- ======= Header ======= -->
<header id="header" class="fixed-top header-inner-pages">
  <div class="container d-flex align-items-center justify-content-between">
    <h1 class="logo"><a href="/">Medical Record</a></h1>
    <!-- Uncomment below if you prefer to use an image logo -->
    <!-- <a href="index.html" class="logo"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->

    <nav id="navbar" class="navbar">
      <ul>
        <li><a class="nav-link scrollto" href="/logout">Log Out</a></li>

      </ul>
      <i class="bi bi-list mobile-nav-toggle"></i>
    </nav><!-- .navbar -->

  </div>
</header><!-- End Header -->

<main id="main">

  <!-- ======= Breadcrumbs ======= -->
  <section class="breadcrumbs">
    <div class="container">

      <div class="d-flex justify-content-between align-items-center">
        <h2>Temporary Tokens</h2>
        <ol>
          <li><a href="/">Home</a></li>
          <li>Temporary tokens</li>
        </ol>
      </div>

    </div>
  </section><!-- End Breadcrumbs -->

  <section class="inner-page">
    <div class="container">
      <article>
        <h1>Temporary Tokens</h1>
        <button class="btn btn-lg" id="scanButton" {{scanbuttonparam}}>Scan</button>
        <button class="btn btn-lg" id="writeButton" {{writebuttonparam}}>Write</button>

      </article>
    </div>
  </section>

</main><!-- End #main -->

<{% endblock %} <script>
  log = console.log;

  if ( !( "NDEFReader" in window ) )
  console.log(
  "Web NFC is not available.\n" +
  'Please make sure the "Experimental Web Platform features" flag is enabled on Android.'
  );
  </script>

  <script>
    scanButton.addEventListener( "click", async () => {
      log( "User clicked scan button" );

      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        log( "> Scan started" );

        ndef.addEventListener( "readingerror", () => {
          log( "Argh! Cannot read data from the NFC tag. Try another one?" );
        } );

        ndef.addEventListener( "reading", ( { message, serialNumber } ) => {
          log( `> Serial Number: ${ serialNumber }` );
          log( `> Records: (${ message.records.length })` );
          const decoder = new TextDecoder();
          for ( const record of message.records ) {
            const txt = decoder.decode( record.data );

            if ( txt.startsWith( "tag_" ) ) {
              window.location.href = "/readtag?tagid=" + txt
            }
          }

        } );
      } catch ( error ) {
        log( "Argh! " + error );
      }
    } );

    writeButton.addEventListener( "click", async () => {
      log( "User clicked write button" );

      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        log( "> Scan started" );

        ndef.addEventListener( "readingerror", () => {
          log( "Argh! Cannot read data from the NFC tag. Try another one?" );
        } );

        ndef.addEventListener( "reading", ( { message, serialNumber } ) => {
          log( "Read" );
        } );
        await ndef.write( "tag_{{token}}" );

        setTimeout( function () {
          console.log( "delay" );
        }, 1000 ); //delay is in milliseconds 

        alert( "Temporary tag provisioned" );
        window.location.href = "/";
      } catch ( error ) {
        alert( "> Error" );
        window.location.href = "/";
      }
    } );

  </script>
  </BODY>

  </HTML>
